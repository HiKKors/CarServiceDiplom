{% extends 'autoService/menu-layout.html' %}
{% load static %}
{% load dict_extras %}
{% load json_extras %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/create_booking.css' %}">
<style>
.availability-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
.availability-table th, .availability-table td { padding: 8px; text-align: center; border: 1px solid #ddd; }
.slot-free { background: #d4edda; cursor: pointer; }
.slot-busy { background: #f8d7da; color: #721c24; }
.slot-selected { background: #ffc107; font-weight: bold; }
.box-label { background: #e9ecef; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<form id="booking-form" method="POST">
    {% csrf_token %}
    
    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
    <input type="hidden" name="box" id="selected-box">
    <input type="hidden" name="start_time" id="selected-start-time">
    <input type="hidden" name="end_time" id="selected-end-time">

    <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
    <label>–î–∞—Ç–∞:</label>
    <input type="date" name="date" value="{{ selected_date }}" min="{{ today }}">
    <button type="button" onclick="showAvailability()">
        –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
    </button>

    <!-- –¢–∞–±–ª–∏—Ü–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ) -->
    {% if availability_data %}
    <div style="margin: 20px 0;">
        <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã:</h3>
        <table class="availability-table">
            <thead>
                <tr>
                    <th>–ë–æ–∫—Å</th>
                    {% for slot in availability_data.time_slots %}
                        <th>{{ slot }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for box in availability_data.boxes %}
                <tr>
                    <td class="box-label">–ë–æ–∫—Å {{ box.name }}</td>
                    {% for slot in availability_data.time_slots %}
                        {% with status=availability_data.table|get_item:box.id|get_item:slot %}
                        <td 
                            class="slot-{{ status }}"
                            data-box-id="{{ box.id }}"
                            data-start-time="{{ slot }}"
                            {% if status == 'free' %}
                                onclick="selectSlot({{ box.id }}, '{{ slot }}')"
                            {% endif %}
                        >
                            {% if status == 'free' %}üöó{% elif status == 'busy' %}‚õî{% endif %}
                        </td>
                        {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
    <label>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</label>
    {{ form.user_car_id }}

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</label>
    {{ form.comment }}

    <label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
    {{ form.equipment }}

    <div>
        <p>–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞: <span id="total-price">0</span> —Ä—É–±</p>
    </div>

    <button type="submit">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
</form>

<script>
// === –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ª–æ—Ç–æ–≤ ===
let currentSelection = {
    boxId: null,
    startSlot: null,
    endSlot: null
};

// –ü–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
{% if availability_data %}
const TIME_SLOTS = {{ availability_data.time_slots|to_json }};
{% else %}
const TIME_SLOTS = [];
{% endif %}

function getSlotIndex(slot) {
    return TIME_SLOTS.indexOf(slot);
}

function clearAllSelection() {
    document.querySelectorAll('.slot-selected').forEach(el => {
        el.classList.remove('slot-selected');
    });
    currentSelection = { boxId: null, startSlot: null, endSlot: null };
    updateFormFields();
}

function selectSlot(boxId, slotTime) {
    console.log(slotTime);
    const cell = event.target;
    if (!cell.classList.contains('slot-free')) return;

    // –°–ª—É—á–∞–π 1: –ø–µ—Ä–≤—ã–π –≤—ã–±–æ—Ä –∏–ª–∏ –¥—Ä—É–≥–æ–π –±–æ–∫—Å
    if (currentSelection.boxId === null || currentSelection.boxId !== boxId) {
        clearAllSelection();
        currentSelection = { boxId, startSlot: slotTime, endSlot: slotTime };
        cell.classList.add('slot-selected');
        updateFormFields();
        return;
    }

    // –°–ª—É—á–∞–π 2: —Ç–æ—Ç –∂–µ –±–æ–∫—Å
    const newSlotIndex = getSlotIndex(slotTime);
    const startSlotIndex = getSlotIndex(currentSelection.startSlot);
    console.log("startSlotIndex", startSlotIndex);
    console.log("newSlotIndex", newSlotIndex);

    if (newSlotIndex < startSlotIndex) {
        console.log("newSlotIndex < startSlotIndex, –°–ë–†–û–°");
        // –†–∞–Ω—å—à–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ ‚Üí —Å–±—Ä–æ—Å
        clearAllSelection();
        currentSelection = { boxId, startSlot: slotTime, endSlot: slotTime };
        cell.classList.add('slot-selected');
    } else {
        console.log("newSlotIndex >= startSlotIndex, –î–ò–ê–ü–ê–ó–û–ù");
        // –ü–æ–∑–∂–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ ‚Üí –¥–∏–∞–ø–∞–∑–æ–Ω
        currentSelection.endSlot = slotTime;
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
        
        const startIndex = getSlotIndex(currentSelection.startSlot);
        const endIndex = getSlotIndex(currentSelection.endSlot);
        
        for (let i = startIndex; i <= endIndex; i++) {
            const time = TIME_SLOTS[i];
            const selector = `.slot-free[data-box-id="${boxId}"][data-start-time="${time}"]`;
            const targetCell = document.querySelector(selector);
            if (targetCell) targetCell.classList.add('slot-selected');
        }
    }
    updateFormFields();
}

function updateFormFields() {
    const boxInput = document.getElementById('selected-box');
    const startInput = document.getElementById('selected-start-time');
    const endInput = document.getElementById('selected-end-time');

    if (currentSelection.startSlot && currentSelection.endSlot) {
        boxInput.value = currentSelection.boxId;
        startInput.value = currentSelection.startSlot;
        
        // –ö–æ–Ω–µ—Ü = –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–æ—Ç + 1 —á–∞—Å
        const [hour, min] = currentSelection.endSlot.split(':').map(Number);
        const endHour = (hour + 1) % 24;
        endInput.value = `${endHour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
    } else {
        boxInput.value = '';
        startInput.value = '';
        endInput.value = '';
    }
}

// === –†–∞—Å—á—ë—Ç —Ü–µ–Ω—ã ===
document.addEventListener('DOMContentLoaded', function() {
    function getSelectedSlots() {
        console.log("getSelectedSlots");
        return document.querySelectorAll('.slot-selected').length;
    }

    function getEquipmentPricePerHour() {
        console.log("getEquipmentPricePerHour");
        let total = 0;

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {

            if (!checkbox.checked) return;

            const label = checkbox.nextElementSibling;

            if (!label) return;

            const match = label.textContent.match(/(\d+)\s*—Ä—É–±/);

            if (match) {
                total += parseInt(match[1]);
            }
        });

        return total;
    }

    function calculateTotalPrice() {
        console.log("calculateTotalPrice");
        const hours = getSelectedSlots();
        console.log(hours);
        const pricePerHour = getEquipmentPricePerHour();

        if (hours === 0 || pricePerHour === 0) {
            document.getElementById('total-price').textContent = '0';
            return;
        }

        const total = hours * pricePerHour;

        console.log("Total", total);

        document.getElementById('total-price').textContent = total;
    }

    /* –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö */
    document.addEventListener('click', function (e) {

        if (e.target.classList.contains('slot-free')) {
            setTimeout(calculateTotalPrice, 50);
        }

    });


    /* –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', calculateTotalPrice);
    });
});

// === –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å" ===
function showAvailability() {
    const date = document.querySelector('[name="date"]').value;
    if (date) {
        window.location.href = `?date=${encodeURIComponent(date)}`;
    }
}
</script>
{% endblock %}