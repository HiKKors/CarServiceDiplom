{% extends 'autoService/menu-layout.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
<title>Детали бронирования</title>
{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .form-label { font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Дополнительные детали бронирования</h2>
    <form action="{% url 'add_booking_detail' service_id booking_id %}" method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        
        <div id="parts-formset">
            {{ formset.management_form }}
            {% for form in formset %}
            <div class="form-row">
                <div class="form-group">
                    {{ form.part|add_class:"select2" }}
                </div>
                <div class="form-group">
                    {{ form.quantity }}
                </div>
                {% if form.DELETE %}
                <div class="form-group">
                    {{ form.DELETE }} <label>Удалить</label>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <button type="button" id="add-more" class="btn btn-primary">Добавить запчасть</button>
        <button type="submit" class="btn btn-success">Сохранить</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Инициализация всех select2 при загрузке страницы
        $('.select2').select2({
            placeholder: "Выберите или введите запчасть",
            allowClear: true,
            tags: true,  // позволяет добавлять новые значения
        });

        // Повторная инициализация select2 при добавлении формы
        $('#add-more').on('click', function() {
            let totalForms = $('#id_form-TOTAL_FORMS');
            let currentCount = parseInt(totalForms.val());
            let newForm = $('#parts-formset .form-row:first').clone(true);

            newForm.find(':input').each(function() {
                let name = $(this).attr('name').replace(`-0-`, `-${currentCount}-`);
                let id = `id_${name}`;
                $(this).attr({'name': name, 'id': id}).val('');
            });

            $('#parts-formset').append(newForm);
            totalForms.val(currentCount + 1);

            // Инициализация select2 для новой формы
            newForm.find('.select2').select2({
                placeholder: "Выберите или введите запчасть",
                allowClear: true,
                tags: true
            });
        });
    });
</script>
{% endblock %}
